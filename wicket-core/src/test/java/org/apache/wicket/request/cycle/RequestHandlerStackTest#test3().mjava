	/** */
	@Test
	public void test3()
	{
		initFlags();

		final Response originalResponse = newResponse();
		final IRequestCycle requestCycle = newRequestCycle(originalResponse);
		final RequestHandlerStack stack = newStack(requestCycle);

		final IRequestHandler handler4 = new IRequestHandler()
		{
			@Override
			public void respond(IRequestCycle requestCycle)
			{
				testFlag4 = true;

				requestCycle.setResponse(newResponse());
			}

			@Override
			public void detach(IRequestCycle requestCycle)
			{
				detachedFlag4 = true;
			}
		};

		final IRequestHandler handler3 = new IRequestHandler()
		{
			@Override
			public void respond(IRequestCycle requestCycle)
			{
				testFlag3 = false;
				stack.schedule(handler4);

				// make sure that handler4's respond method is fired after this
				// one ends
				testFlag4 = false;

				// code must be be reached
				testFlag3 = true;
			}

			@Override
			public void detach(IRequestCycle requestCycle)
			{
				detachedFlag3 = true;
			}
		};

		final IRequestHandler handler2 = new IRequestHandler()
		{
			@Override
			public void respond(IRequestCycle requestCycle)
			{
				testFlag2 = false;
				stack.execute(handler3);
				// code must be reached
				testFlag2 = true;
			}

			@Override
			public void detach(IRequestCycle requestCycle)
			{
				detachedFlag2 = true;
			}
		};

		IRequestHandler handler1 = new IRequestHandler()
		{
			@Override
			public void respond(IRequestCycle requestCycle)
			{
				testFlag1 = false;
				stack.execute(handler2);

				// code must be reached
				testFlag1 = true;
			}

			@Override
			public void detach(IRequestCycle requestCycle)
			{
				detachedFlag1 = true;
			}
		};

		stack.execute(handler1);

		assertEquals(requestCycle.getResponse(), originalResponse);

		stack.detach();

		assertTrue(testFlag1);
		assertTrue(testFlag2);
		assertTrue(testFlag3);
		assertTrue(testFlag4);

		assertTrue(detachedFlag1);
		assertTrue(detachedFlag2);
		assertTrue(detachedFlag3);
		assertTrue(detachedFlag4);
	}

